!	f90 -O2 robot2.f -o robot2.exe
!       mpif90 -fopenmp -O2 -mcmodel=medium  robot2.f -o robot2.exe
	PROGRAM ROBOT
	IMPLICIT REAL*8 (a-h,o-z)
	REAL*8, PARAMETER :: PI=3.1415926535898D0
	REAL*8 XROB(10000),YROB(10000),ZROB(10000)	
	INTEGER IRROB(3,10000)
	REAL*8 XPLA(10000),YPLA(10000),ZPLA(10000)	
	INTEGER IRPLA(3,10000)	
	REAL*8 XROB2(10000),YROB2(10000),ZROB2(10000)	
	INTEGER IRROB2(3,10000)
	REAL*8 XDET(10000),YDET(10000),ZDET(10000)	
	INTEGER IRDET(3,10000)
	REAL*8 XLAS(10000),YLAS(10000),ZLAS(10000)	
	INTEGER IRLAS(3,10000)
	REAL*8 XECH(10000),YECH(10000),ZECH(10000)	
	INTEGER IRECH(3,10000)
	REAL*8 XECH0(10000),YECH0(10000),ZECH0(10000)	
	INTEGER IRECH0(3,10000)
	REAL*8 XDET0(10000),YDET0(10000),ZDET0(10000)	
	INTEGER IRDET0(3,10000)
	REAL*8 XLAS0(10000),YLAS0(10000),ZLAS0(10000)	
	INTEGER IRLAS0(3,10000)
	
	
	
	REAL*8 XB(10000),YB(10000),ZB(10000)	
	REAL*8 XC(10000),YC(10000),ZC(10000)	
	INTEGER IRB(3,10000)	
	REAL*8 XA(10000),YA(10000),ZA(10000)
	INTEGER IRA(3,10000)
	REAL*8 XCARRE(2,4),YCARRE(2,4),ZCARRE(2,4)		
	REAL*8 XBASE(2,100),YBASE(2,1000),ZBASE(2,1000)	
	  INTEGER IDIR1(0:10000),IDIR2(0:10000)
        REAL*8 XTRECH(4,4)
        REAL*8 XTRECH2(4,4)

        
        REAL*8 TABALPHA10(1000000)
        REAL*8 TABALPHA20(1000000)
        REAL*8 TABALPHA30(1000000)
        REAL*8 TABALPHA40(1000000)
        REAL*8 TABALPHA50(1000000)
        REAL*8 TABALPHA60(1000000)
        REAL*8 TABGAMMA0(1000000)
        REAL*8 TABDELTA0(1000000)
        REAL*8 TABTETAI0(1000000)        
        REAL*8 TABPHII0(1000000)          
        REAL*8 TABTETAO0(1000000)  
        REAL*8 TABPHIO0(1000000)           
  
        !INTEGER IINV(2,100000)
        INTEGER IRPOL(4,100000)
 	character*7 ch     
        
        
  !mattrices hohmogenes de transformation
        REAL*8 XTR0(4,4)
        REAL*8 XTR1(4,4),XTR2(4,4)
        REAL*8 XTR3(4,4),XTR4(4,4)
        REAL*8 XTR5(4,4),XTR6(4,4),XTR7(4,4)
        REAL*8 XTR(4,4)
        
        REAL*8 XV(4),XV2(4)

        REAL*8 XM1(3,3)
        REAL*8 XM2(3,3),XM3(3,3)
        REAL*8 XMT(3,3),XM(3,3)
	REAL*8 XM03(3,3),XM60(3,3)
	REAL*8 XM63(3,3)
	REAL*8 XM60A(3,3),XM60B(3,3)        

        REAL*8 XJ1(3),XJ2(3)
	

	AL1OLD=0.D0
	AL2OLD=0.D0
	AL3OLd=0.D0	
	AL4OLD=0.D0
	AL5OLD=0.D0
	AL6OLd=0.D0
	
        !lecture des parametres geometriques
        write(6,*) 'lecture des parametres geometriques'
	CALL LIREDATA(PX,PY,PZ,
     &  XLCYLPOIGNEE,XLCYLBASE,XLCYLBRAS,XLCYLAVBRAS,
     &  XLBRASDETEC,XLBRASLAS,XECHAN,XEPPLATEAU,
     &  XDECBRAS,XDECAVBRAS,XDECPOIGNET,XCOUDE,      
     &  AL1MIN,AL1MAX,AL2MIN,AL2MAX,AL3MIN,AL3MAX,
     &  AL4MIN,AL4MAX,AL5MIN,AL5MAX,AL6MIN,AL6MAX)	
!	PHIIMIN0=AL6MIN*180.D0/PI+90.D0+0.01D0
!	PHIIMAX0=AL6MAX*180.D0/PI+90.D0-0.01D0
	PHIIMIN0=-180.D0
	PHIIMAX0=360.D0

!	write(6,*) PHIIMIN0,PHIIMAX0
	
	
!        ALPHA10=1.979782D0
!        ALPHA20=2.525696D0
!        ALPHA30=32.534356D0
!        ALPHA40=-8.070852D0
!        ALPHA50=10.020107D0
!        ALPHA60=-78.450864D0 
!        GAMMA0=148.922529D0
!        DELTA0 =106.937618D0
!        TETAI0=45.D0
!        PHII0=175.D0
!        TETAO0=60.D0
!        PHIO0=185.D0   


        
        
	!write(6,*) XDECBRAS,XDECAVBRAS,XDECPOIGNET
	
!	!on dessine toute la scène
!	!le plateau 
!	CALL AFFICHEPLATEAU(GAMMA0,
!     &	XEPPLATEAU,XLCYLBASE,PX,PY,
!     &  XPLA,YPLA,ZPLA,IRPLA,NPPLA,NFPLA)
!	!le robot 
!	CALL AFFICHEROBOT(
!     &	ALPHA10,ALPHA20,ALPHA30,ALPHA40,ALPHA50,ALPHA60,
!     &  XLCYLBASE,XLCYLBRAS,XLCYLAVBRAS,XLCYLPOIGNEE,XECHAN,
!     &  XDECBRAS,XDECAVBRAS,XDECPOIGNET,XCOUDE,      
!     &  XROB,YROB,ZROB,IRROB,NPROB,NFROB,XTRECH)
!        CALL ROTROBOT(GAMMA0,PX,PY,
!     &	XROB,YROB,ZROB,IRROB,NPROB,NFROB,
!     &  XROB2,YROB2,ZROB2,IRROB2,NPROB2,NFROB2,XTRECH2)
!	CALL TRANSXTRANS2(XTRECH2,XTRECH)
!        !l 'echantillon
!	CALL ECHANTILLON(XECHAN,XTRECH2,
!     &  XECH,YECH,ZECH,IRECH,NPECH,NFECH)
!	!le detecteur
!	CALL DETECTEUR(PZ,DELTA0,XLBRASDETEC,
!     &  XDET,YDET,ZDET,IRDET,NPDET,NFDET)	
!	!le laser
!	CALL DETECTEUR(PZ,90.D0,XLBRASLAS,
!     &  XLAS,YLAS,ZLAS,IRLAS,NPLAS,NFLAS)
!        !l'echantillon dans le repere echantillon
!   	CALL ECH0(XECH0,YECH0,ZECH0,IRECH0,NPECH0,NFECH0)	   
!        ! le laser dasn le repere echantillon
!        CALL LAS0(PHII0,TETAI0,XLAS0,YLAS0,ZLAS0,IRLAS0,NPLAS0,NFLAS0)	
!        ! le detecteur dasn le repere echantillon
!        CALL LAS0(PHIO0,TETAO0,XDET0,YDET0,ZDET0,IRDET0,NPDET0,NFDET0)	
     


 
    	  
!	OPEN(20,file='vuetecplot2')
!	WRITE(20,'(a)')  'TITLE="jj"' 
!	WRITE(20,'(a)')  ' VARIABLES = "X","Y","Z"'  	
!	WRITE(20,*) 'ZONE T="robot" ET=TRIANGLE, F=FEBLOCK, N='
!     &	,NPROB2,' E=',NFROB2
!         WRITE(20,'(8e15.7)') (XROB2(J),J=1,NPROB2)
!	 WRITE(20,'(8e15.7)') (YROB2(J),J=1,NPROB2)
!	 WRITE(20,'(8e15.7)') (ZROB2(J),J=1,NPROB2)
!	 DO I=1,NFROB2
!	 WRITE(20,'(3i8)') (IRROB2(IJ,I),IJ=1,3)
!	 ENDDO 
!	WRITE(20,*) 'ZONE T="plaque" ET=TRIANGLE, F=FEBLOCK, N='
!     &	,NPPLA,' E=',NFPLA
!         WRITE(20,'(8e15.7)') (XPLA(J),J=1,NPPLA)
!	 WRITE(20,'(8e15.7)') (YPLA(J),J=1,NPPLA)
!	 WRITE(20,'(8e15.7)') (ZPLA(J),J=1,NPPLA)
!	 DO I=1,NFPLA
!	 WRITE(20,'(3i8)') (IRPLA(IJ,I),IJ=1,3)
!	 ENDDO 	 
!	WRITE(20,*) 'ZONE T="detec" ET=TRIANGLE, F=FEBLOCK, N='
!     &	,NPDET,' E=',NFDET
!         WRITE(20,'(8e15.7)') (XDET(J),J=1,NPDET)
!	 WRITE(20,'(8e15.7)') (YDET(J),J=1,NPDET)
!	 WRITE(20,'(8e15.7)') (ZDET(J),J=1,NPDET)
!	 DO I=1,NFDET
!	 WRITE(20,'(3i8)') (IRDET(IJ,I),IJ=1,3)
!	 ENDDO 	
!	WRITE(20,*) 'ZONE T="laser" ET=TRIANGLE, F=FEBLOCK, N='
!     &	,NPLAS,' E=',NFLAS
!         WRITE(20,'(8e15.7)') (XLAS(J),J=1,NPLAS)
!	 WRITE(20,'(8e15.7)') (YLAS(J),J=1,NPLAS)
!	 WRITE(20,'(8e15.7)') (ZLAS(J),J=1,NPLAS)
!	 DO I=1,NFLAS
!	 WRITE(20,'(3i8)') (IRLAS(IJ,I),IJ=1,3)
!	 ENDDO 	
!	WRITE(20,*) 'ZONE T="echan" ET=TRIANGLE, F=FEBLOCK, N='
!     &	,NPECH,' E=',NFECH
!         WRITE(20,'(8e15.7)') (XECH(J),J=1,NPECH)
!	 WRITE(20,'(8e15.7)') (YECH(J),J=1,NPECH)
!	 WRITE(20,'(8e15.7)') (ZECH(J),J=1,NPECH)
!	 DO I=1,NFECH
!	 WRITE(20,'(3i8)') (IRECH(IJ,I),IJ=1,3)
!	 ENDDO 	
!	 WRITE(20,*) 'ZONE T="echan0" ET=TRIANGLE, F=FEBLOCK, N='
!     &	,NPECH0,' E=',NFECH0
!         WRITE(20,'(8e15.7)') (XECH0(J),J=1,NPECH0)
!	 WRITE(20,'(8e15.7)') (YECH0(J),J=1,NPECH0)
!	 WRITE(20,'(8e15.7)') (ZECH0(J),J=1,NPECH0)
!	 DO I=1,NFECH0
!	 WRITE(20,'(3i8)') (IRECH0(IJ,I),IJ=1,3)
!	 ENDDO 	
!	WRITE(20,*) 'ZONE T="laser0" ET=TRIANGLE, F=FEBLOCK, N='
!     &	,NPLAS0,' E=',NFLAS0
!         WRITE(20,'(8e15.7)') (XLAS0(J),J=1,NPLAS0)
!	 WRITE(20,'(8e15.7)') (YLAS0(J),J=1,NPLAS0)
!	 WRITE(20,'(8e15.7)') (ZLAS0(J),J=1,NPLAS0)
!	 DO I=1,NFLAS0
!	 WRITE(20,'(3i8)') (IRLAS0(IJ,I),IJ=1,3)
!	 ENDDO 	
!	WRITE(20,*) 'ZONE T="detec0" ET=TRIANGLE, F=FEBLOCK, N='
!     &	,NPDET0,' E=',NFDET0
!         WRITE(20,'(8e15.7)') (XDET0(J),J=1,NPDET0)
!	 WRITE(20,'(8e15.7)') (YDET0(J),J=1,NPDET0)
!	 WRITE(20,'(8e15.7)') (ZDET0(J),J=1,NPDET0)
!	 DO I=1,NFDET0
!	 WRITE(20,'(3i8)') (IRDET0(IJ,I),IJ=1,3)
!	 ENDDO 	
!	 close(20)

!        write(6,'(4e15.6)') XTRECH2(1,1),XTRECH2(1,2),
!     &        XTRECH2(1,3),XTRECH2(1,4)
!        write(6,'(4e15.6)') XTRECH2(2,1),XTRECH2(2,2),
!     &        XTRECH2(2,3),XTRECH2(2,4)
!        write(6,'(4e15.6)') XTRECH2(3,1),XTRECH2(3,2),
!     &        XTRECH2(3,3),XTRECH2(3,4)     
!        write(6,'(4e15.6)') XTRECH2(4,1),XTRECH2(4,2),
!     &        XTRECH2(4,3),XTRECH2(4,4)          

!        write(6,'(4e15.6)') XTRECH(1,1),XTRECH(1,2),
!     &        XTRECH(1,3),XTRECH(1,4)
!        write(6,'(4e15.6)') XTRECH(2,1),XTRECH(2,2),
!     &        XTRECH(2,3),XTRECH(2,4)
!        write(6,'(4e15.6)') XTRECH(3,1),XTRECH(3,2),
!     &        XTRECH(3,3),XTRECH(3,4)     
!        write(6,'(4e15.6)') XTRECH(4,1),XTRECH(4,2),
!     &        XTRECH(4,3),XTRECH(4,4)      
     
         !stop
     
      !specifique

!      	AL1OLD=0.d0
!	AL2OLD=0.d0
!	AL3OLD=0.d0
!	AL4OLD=0.d0
!	AL5OLD=0.d0
!	AL6OLD=0.d0
!      
       !je recupere XM60
     
!        XM60(1,1)=XTRECH(1,1)
!        XM60(1,2)=XTRECH(1,2)
!        XM60(1,3)=XTRECH(1,3)        
!        XM60(2,1)=XTRECH(2,1)
!        XM60(2,2)=XTRECH(2,2)
!        XM60(2,3)=XTRECH(2,3)        
!        XM60(3,1)=XTRECH(3,1)
!        XM60(3,2)=XTRECH(3,2)
!        XM60(3,3)=XTRECH(3,3)        

!        !je recupere P par rapport à R0
!        PXB=XTRECH(1,4)
!        PYB=XTRECH(2,4)
!        PZB=XTRECH(3,4) 


!         !je recupere k6
!        XK0=XM60(1,3)
!	YK0=XM60(2,3)
!	ZK0=XM60(3,3)       
        
        !special !je rajoute l'epaisseur echantillon
        !a virer quand je fias la routine finale
        
!        PX=PXB+0.005D0*XK0
!        PY=PYB+0.005D0*YK0
!        PZ=PZB+0.005D0*ZK0
	
        
!	CALL SOLVEROBOT2(XM60,PHIO0,
!     &  PX,PY,PZ,XK0,YK0,ZK0,
!     &  XLCYLPOIGNEE,XDECPOIGNET,XLCYLBASE,
!     &	XLCYLBRAS,XDECBRAS,XLCYLAVBRAS,XDECAVBRAS,
!     &  AL1MIN,AL2MIN,AL3MIN,AL4MIN,AL5MIN,AL6MIN,
!     &  AL1MAX,AL2MAX,AL3MAX,AL4MAX,AL5MAX,AL6MAX,     
!     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD, 
!     &  IFIND,AL1F,AL2F,AL3F,AL4F,AL5F,AL6F)        

 
	 
!	stop
	
        write(6,*) 'lecture de la consigne'	
	CALL LIRECONSIGNE(IMODE,IDESSIN,
     &	TETAI0,PHII0,TETAO0,PHIO0,DELTA0,
     &  NDELTA0,NGAMMA0,IDEMI,
     &  NTETAI0,NPHII0,NTETAO0,PHIIDEB0,PHIIFIN0)

      !XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXxxxxxx
        if(imode.EQ.1) theN  !un point precis en incidence et en observation
        CALL MODE1(TETAI0,PHII0,TETAO0,PHIO0,DELTA0,
     &  NDELTA0,NGAMMA0,IDEMI,PHIIMIN0,PHIIMAX0,
     &  NTETAI0,NPHII0,NTETAO0,PHIIDEB0,PHIIFIN0,
     &  PX,PY,PZ,
     &  XLCYLPOIGNEE,XDECPOIGNET,XLCYLBASE,
     &	XLCYLBRAS,XDECBRAS,XLCYLAVBRAS,XDECAVBRAS,
     &  XLBRASDETEC,XLBRASLAS,XECHAN,XEPPLATEAU,
     &  AL1MIN,AL1MAX,AL2MIN,AL2MAX,AL3MIN,AL3MAX,
     &  AL4MIN,AL4MAX,AL5MIN,AL5MAX,AL6MIN,AL6MAX,
     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD,     
     &  TABALPHA10,TABALPHA20,TABALPHA30,TABALPHA40,
     &  TABALPHA50,TABALPHA60,TABGAMMA0,TABDELTA0,
     &  TABTETAI0,TABPHII0,TABTETAO0,TABPHIO0,NSAMPLE)
       !XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXxxxxxx
        ELSEIF(imode.EQ.2) theN !un point precis en incidence et une plage de  delta d'observation
	CALL MODE2(TETAI0,PHII0,TETAO0,PHIO0,DELTA0,
     &  NDELTA0,NGAMMA0,IDEMI,PHIIMIN0,PHIIMAX0,
     &  NTETAI0,NPHII0,NTETAO0,PHIIDEB0,PHIIFIN0,
     &  PX,PY,PZ,
     &  XLCYLPOIGNEE,XLCYLBASE,XLCYLBRAS,XLCYLAVBRAS,
     &  XLBRASDETEC,XLBRASLAS,XECHAN,XEPPLATEAU,
     &  XDECBRAS,XDECAVBRAS, XDECPOIGNET,
     &  AL1MIN,AL1MAX,AL2MIN,AL2MAX,AL3MIN,AL3MAX,
     &  AL4MIN,AL4MAX,AL5MIN,AL5MAX,AL6MIN,AL6MAX,
     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD,     
     &  TABALPHA10,TABALPHA20,TABALPHA30,TABALPHA40,
     &  TABALPHA50,TABALPHA60,TABGAMMA0,TABDELTA0,
     &  TABTETAI0,TABPHII0,TABTETAO0,TABPHIO0,NSAMPLE)
       !XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXxxxxxx        
        ELSEIF(imode.eq.3) THEN !un point precis en incidence et un demi espace en observation
	CALL MODE3(TETAI0,PHII0,TETAO0,PHIO0,DELTA0,
     &  NDELTA0,NGAMMA0,IDEMI,PHIIMIN0,PHIIMAX0,
     &  NTETAI0,NPHII0,NTETAO0,PHIIDEB0,PHIIFIN0,
     &  PX,PY,PZ,
     &  XLCYLPOIGNEE,XLCYLBASE,XLCYLBRAS,XLCYLAVBRAS,
     &  XLBRASDETEC,XLBRASLAS,XECHAN,XEPPLATEAU,
     &  XDECBRAS,XDECAVBRAS,XDECPOIGNET,     
     &  AL1MIN,AL1MAX,AL2MIN,AL2MAX,AL3MIN,AL3MAX,
     &  AL4MIN,AL4MAX,AL5MIN,AL5MAX,AL6MIN,AL6MAX,
     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD,     
     &  TABALPHA10,TABALPHA20,TABALPHA30,TABALPHA40,
     &  TABALPHA50,TABALPHA60,TABGAMMA0,TABDELTA0,
     &  TABTETAI0,TABPHII0,TABTETAO0,TABPHIO0,NSAMPLE)
        !maillage polaire
         NQUAD=(NGAMMA0-1)*(NDELTA0-1)
         DO K0=1,NQUAD
 	 JJ=INT(REAL(K0-1,8)/(NGAMMA0-1))+1 
 	 II=K0-(JJ-1)*(NGAMMA0-1)         
         !write(6,*) K0,II,JJ
         IF(MOD(JJ,2).eq.0) THEN
         I1=(JJ-1)*NGAMMA0+II
         I2=(JJ-1)*NGAMMA0+II+1
         I3=(JJ)*NGAMMA0+NGAMMA0-II
         I4=(JJ)*NGAMMA0+NGAMMA0-II+1
         ELSE
         I1=(JJ-1)*NGAMMA0+NGAMMA0-II+1
         I2=(JJ-1)*NGAMMA0+NGAMMA0-II
         I3=(JJ)*NGAMMA0+II+1
         I4=(JJ)*NGAMMA0+II         
         ENDIF
         IRPOL(1,K0)=I1
         IRPOL(2,K0)=I2         
         IRPOL(3,K0)=I3         
         IRPOL(4,K0)=I4        
         ! write(6,*) K0,(IRPOL(J,K0),J=1,4)
         ENDDO
        !tecplot du maillage polaire
         OPEN(30,file='output/polaire')   
  	 WRITE(30,'(a)')  'TITLE="polaire"' 
	 WRITE(30,'(a)')  ' VARIABLES = "X","Y","Z"'  	
	 WRITE(30,*) 
     &	 'ZONE T="maillage", F=FEPOINT, ET=QUADRILATERAL, N='
     &	,NSAMPLE,' E=',NQUAD
         DO K0=1,NSAMPLE
         RR = TABTETAO0(K0)
         ANG= TABPHIO0(K0)*PI/180.D0
         XX = RR*COS(ANG)
         YY = RR*SIN(ANG)
         ZZ = 0.D0
          write(30,*) XX,YY,ZZ
         ENDDO
         DO K0=1,NQUAD
          write(30,*) (IRPOL(J,K0),J=1,4)
         ENDDO         
         CLOSE(30)         
        !XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXxxxxxx      
        ELSEIF(IMODE.EQ.4) THEN !phii fixe, tetai plage de 0 à 90, tetao et phio fixe aussi
	CALL MODE4(TETAI0,PHII0,TETAO0,PHIO0,DELTA0,
     &  NDELTA0,NGAMMA0,IDEMI,PHIIMIN0,PHIIMAX0,
     &  NTETAI0,NPHII0,NTETAO0,PHIIDEB0,PHIIFIN0,
     &  PX,PY,PZ,
     &  XLCYLPOIGNEE,XLCYLBASE,XLCYLBRAS,XLCYLAVBRAS,
     &  XLBRASDETEC,XLBRASLAS,XECHAN,XEPPLATEAU,
     &  XDECBRAS,XDECAVBRAS, XDECPOIGNET,     
     &  AL1MIN,AL1MAX,AL2MIN,AL2MAX,AL3MIN,AL3MAX,
     &  AL4MIN,AL4MAX,AL5MIN,AL5MAX,AL6MIN,AL6MAX,
     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD,     
     &  TABALPHA10,TABALPHA20,TABALPHA30,TABALPHA40,
     &  TABALPHA50,TABALPHA60,TABGAMMA0,TABDELTA0,
     &  TABTETAI0,TABPHII0,TABTETAO0,TABPHIO0,NSAMPLE)	
        !XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXxxxxxx      
        ELSEIF(IMODE.EQ.5) THEN !tetai fixe, phii plage de phimin a phimax, tetao et phio fixe aussi
        CALL MODE5(TETAI0,PHII0,TETAO0,PHIO0,DELTA0,
     &  NDELTA0,NGAMMA0,IDEMI,PHIIMIN0,PHIIMAX0,
     &  NTETAI0,NPHII0,NTETAO0,PHIIDEB0,PHIIFIN0,
     &  PX,PY,PZ,
     &  XLCYLPOIGNEE,XLCYLBASE,XLCYLBRAS,XLCYLAVBRAS,
     &  XLBRASDETEC,XLBRASLAS,XECHAN,XEPPLATEAU,
     &  XDECBRAS,XDECAVBRAS, XDECPOIGNET,     
     &  AL1MIN,AL1MAX,AL2MIN,AL2MAX,AL3MIN,AL3MAX,
     &  AL4MIN,AL4MAX,AL5MIN,AL5MAX,AL6MIN,AL6MAX,
     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD,     
     &  TABALPHA10,TABALPHA20,TABALPHA30,TABALPHA40,
     &  TABALPHA50,TABALPHA60,TABGAMMA0,TABDELTA0,
     &  TABTETAI0,TABPHII0,TABTETAO0,TABPHIO0,NSAMPLE)
         !XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXxxxxxx      
        ELSEIF(IMODE.EQ.6) THEN !phii fixe, tetai fixe,  phiO = phii ou phii+PI tetao plage de 0 à 90
        CALL MODE6(TETAI0,PHII0,TETAO0,PHIO0,DELTA0,
     &  NDELTA0,NGAMMA0,IDEMI,PHIIMIN0,PHIIMAX0,
     &  NTETAI0,NPHII0,NTETAO0,PHIIDEB0,PHIIFIN0,
     &  PX,PY,PZ,
     &  XLCYLPOIGNEE,XLCYLBASE,XLCYLBRAS,XLCYLAVBRAS,
     &  XLBRASDETEC,XLBRASLAS,XECHAN,XEPPLATEAU,
     &  XDECBRAS,XDECAVBRAS, XDECPOIGNET,     
     &  AL1MIN,AL1MAX,AL2MIN,AL2MAX,AL3MIN,AL3MAX,
     &  AL4MIN,AL4MAX,AL5MIN,AL5MAX,AL6MIN,AL6MAX,
     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD,     
     &  TABALPHA10,TABALPHA20,TABALPHA30,TABALPHA40,
     &  TABALPHA50,TABALPHA60,TABGAMMA0,TABDELTA0,
     &  TABTETAI0,TABPHII0,TABTETAO0,TABPHIO0,NSAMPLE)          
         !XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXxxxxxx      
         ELSEIF(IMODE.EQ.7) THEN !phii fixe, tetai plage de 0 à 90, phi0 = phii ou phii+PI tetao plage de 0 à 90

         
         
        TETAIDEB0=0.D0
        TETAIFIN0=90.D0
        K0=0
        DO K=1,NTETAI0
        AA = REAL(K-1,8)/(NTETAI0-1)
 	TETAI0=TETAIDEB0+AA*(TETAIFIN0-TETAIDEB0)        
	DO K2=1,2*NTETAO0-1
	IF(K2.LE.NTETAO0) THEN
	 AA = REAL(K2-1,8)/(NTETAO0-1)	
         TETAODEB=90.D0
         TETAOFIN=0.D0
	 TETAO0=TETAODEB+AA*(TETAOFIN-TETAODEB)
	 PHIO0=PHII0
	ELSE
	 K3=K2-NTETAO0
	 AA=REAL(K3,8)/(NTETAO0-1)
         TETAODEB=0.D0
         TETAOFIN=90.D0
	 TETAO0=TETAODEB+AA*(TETAOFIN-TETAODEB)
	 PHIO0=PHII0+180.D0	 
	ENDIF	
	CALL TETAPHI2MAT(TETAI0,PHII0,TETAO0,PHIO0,
     &  ALPHA,BETA,GAMMA,DELTA,XM60A,XM60B)
        ALPHA0=ALPHA*180.D0/PI
        BETA0=BETA*180.D0/PI
        GAMMA0=GAMMA*180.D0/PI
        DELTA0=DELTA*180.D0/PI
        !write(6,*) ALPHA0,BETA0,GAMMA0,DELTA0
!        XK=XM60A(1,3)
!	YK=XM60A(2,3)
!	ZK=XM60A(3,3)
!	XPP=PX-XK*XLCYLPOIGNEE
!	YPP=PY-YK*XLCYLPOIGNEE
!	ZPP=PZ-ZK*XLCYLPOIGNEE-XLCYLBASE	
!	XM60=XM60A
!	CALL SOLVEROBOT(XPP,YPP,ZPP,XM60,
!     &	XLCYLBRAS,XLCYLAVBRAS,
!     &  AL1MIN,AL2MIN,AL3MIN,AL4MIN,AL5MIN,AL6MIN,
!     &  AL1MAX,AL2MAX,AL3MAX,AL4MAX,AL5MAX,AL6MAX,     
!     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD, 
!     &  IFIND,AL1F,AL2F,AL3F,AL4F,AL5F,AL6F)	
	XM60=XM60A
	XK0=XM60(1,3)
	YK0=XM60(2,3)
	ZK0=XM60(3,3)	
	CALL SOLVEROBOT2(XM60,PHII0,
     &  PX,PY,PZ,XK0,YK0,ZK0,K0,
     &  XLCYLPOIGNEE,XDECPOIGNET,XLCYLBASE,
     &	XLCYLBRAS,XDECBRAS,XLCYLAVBRAS,XDECAVBRAS,
     &  AL1MIN,AL2MIN,AL3MIN,AL4MIN,AL5MIN,AL6MIN,
     &  AL1MAX,AL2MAX,AL3MAX,AL4MAX,AL5MAX,AL6MAX,     
     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD, 
     &  IFIND,AL1F,AL2F,AL3F,AL4F,AL5F,AL6F)

	IF(IFIND.EQ.1) THEN
	ALPHA10=AL1F*180.D0/PI
	ALPHA20=AL2F*180.D0/PI	
	ALPHA30=AL3F*180.D0/PI
	ALPHA40=AL4F*180.D0/PI
	ALPHA50=AL5F*180.D0/PI
	ALPHA60=AL6F*180.D0/PI
        AL1OLD=AL1F
        AL2OLD=AL2F
        AL3OLD=AL3F
        AL4OLD=AL4F
        AL5OLD=AL5F
        AL6OLD=AL6F
        K0=K0+1        
        TABALPHA10(K0)=AL1F*180.D0/PI
        TABALPHA20(K0)=AL2F*180.D0/PI
        TABALPHA30(K0)=AL3F*180.D0/PI
        TABALPHA40(K0)=AL4F*180.D0/PI
        TABALPHA50(K0)=AL5F*180.D0/PI
        TABALPHA60(K0)=AL6F*180.D0/PI        
        TABGAMMA0(K0)=GAMMA0
        TABDELTA0(K0)=DELTA0        
        TABTETAI0(K0)=TETAI0
        TABPHII0(K0)=PHII0        
        TABTETAO0(K0)=TETAO0
        TABPHIO0(K0)=PHIO0        
        ENDIF        
        ENDDO
        ENDDO
	NSAMPLE=K0   	
	
      !XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXxxxxxx        
        ELSEIF(imode.eq.8) THEN !!phii fixe, tetai plage de 0 à 90, on balaye le demi hemisphere
         IDEMI=2
         TETAIDEB0=0.D0
         TETAIFIN0=90.D0
         K0=0
         DO KA=1,NTETAI0!1,NTETAI0
         AA = REAL(KA-1,8)/(NTETAI0-1)
 	 TETAI0=TETAIDEB0+AA*(TETAIFIN0-TETAIDEB0)   
         !write(6,*) 'a',KA,TETAI0,PHII0
         CALL TETAPHI2ALPHABETA(TETAI0,PHII0,
     &   ALPHA,BETA,XM60A)
         ALPHA0=ALPHA*180.D0/PI
         BETA0=BETA*180.D0/PI
        ! write(6,*) 'a2',KA,TETAI0,PHII0,ALPHA0,BETA0         
         DELTADEB0=90.D0  !debut
         DELTAFIN0=180.D0+TETAI0 !fin
         DELTAINC0=180.D0-BETA0 !passage obligé
         !delta moyen
         deltamoyen=(DELTAFIN0-DELTADEB0)/NDELTA0
         !write(6,*) 'a3',DELTADEB0,DELTAINC0,DELTAFIN0
         !NDELTA=(DELTAFIN0-DELTADEB0)/DDELTA0+1
         IF(ABS(DELTAINC0-DELTADEB0).GT.1.D-12) THEN
         NDELTA=NDELTA0
         NDELTA1=MAX(2,INT((DELTAINC0-DELTADEB0)/deltamoyen))
         IF(ABS(DELTAFIN0-DELTAINC0).GT.1.D-12) THEN
         NDELTA2=MAX(2,NDELTA-NDELTA1)
         NDELTA=NDELTA1+NDELTA2
         ELSE
         NDELTA=NDELTA1
         NDELTA2=0
         ENDIF
         ELSE
         NDELTA1=0
         NDELTA2=NDELTA0
         NDELTA=NDELTA0
         ENDIF
         !write(6,*) 'a4',NDELTA1,NDELTA2,NDELTA         
        ! IINCRUSTE=0
         DO K=1,NDELTA
          IF(K.LE.NDELTA1) THEN
          AA=REAL(K-1,8)/(NDELTA1-1)
          DELTA0=DELTADEB0+AA*(DELTAINC0-DELTADEB0)
          ELSE
          KB=K-NDELTA1
          AA=REAL(KB,8)/(NDELTA2)
          DELTA0=DELTAINC0+AA*(DELTAFIN0-DELTAINC0)         
          ENDIF
	  CALL PLAGEGAMMA(TETAI0,PHII0,DELTA0,
     &    GAMMADEB,GAMMAFIN)    
           !write(6,*) 'b',K,DELTA0,GAMMADEB,GAMMAFIN
           !NGAMMA=(GAMMAFIN-GAMMADEB)/DGAMMA0+1   
           NGAMMA=NGAMMA0
           IF(K.EQ.1) THEN
            NGAMMA=1  !dans ce mode je ne duplique pas les points singuliers
            GAMMADEB=-180.D0
            GAMMAFIN=-180.D0
           ENDIF
           IF(K.EQ.NDELTA) THEN
            NGAMMA=1 !dans ce mode je ne duplique pas les poits singuliers
            GAMMADEB=0.D0
            GAMMAFIN=0.D0
           ENDIF           
           IF(IDEMI.EQ.2) THEN
           GAMMAFIN=0.D0
           ENDIF
           DO K2=1,NGAMMA
           IF(MOD(K,2).EQ.0) THEN
            GAMMAINI=GAMMADEB
            GAMMAEND=GAMMAFIN
           ELSE
            GAMMAINI=GAMMAFIN
            GAMMAEND=GAMMADEB          
           ENDIF
           IF(NGAMMA.GT.1) THEN
           AA=REAL(K2-1,8)/(NGAMMA-1)
           ELSE
           AA = 0.D0
           ENDIF
           GAMMA0=GAMMAINI+AA*(GAMMAEND-GAMMAINI)        
           !write(6,*) 'c',K2,DELTA0,GAMMA0
           CALL ABGDTOTETAPHI(ALPHA0,BETA0,GAMMA0,DELTA0,
     &     TETAI,PHII,TETAO,PHIO) 
           !TETAI0=TETAI*180.D0/PI
           !PHII0=PHII*180.D0/PI
          ! write(6,*) 'c2',K,K2,TETAI0,PHII0          
           TETAO0=TETAO*180.D0/PI
           PHIO0=PHIO*180.D0/PI     
           !determination robot 
! 	   XK=XM60A(1,3)
!	   YK=XM60A(2,3)
!	   ZK=XM60A(3,3)
!	   XPP=PX-XK*XLCYLPOIGNEE
!	   YPP=PY-YK*XLCYLPOIGNEE
!	   ZPP=PZ-ZK*XLCYLPOIGNEE-XLCYLBASE	
!	   XM60=XM60A
!	   CALL SOLVEROBOT(XPP,YPP,ZPP,XM60,
!     &	   XLCYLBRAS,XLCYLAVBRAS,
!     &     AL1MIN,AL2MIN,AL3MIN,AL4MIN,AL5MIN,AL6MIN,
!     &     AL1MAX,AL2MAX,AL3MAX,AL4MAX,AL5MAX,AL6MAX,     
!     &     AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD, 
!     &     IFIND,AL1F,AL2F,AL3F,AL4F,AL5F,AL6F)	
	XM60=XM60A
	XK0=XM60(1,3)
	YK0=XM60(2,3)
	ZK0=XM60(3,3)	
	CALL SOLVEROBOT2(XM60,PHII0,
     &  PX,PY,PZ,XK0,YK0,ZK0,K0,
     &  XLCYLPOIGNEE,XDECPOIGNET,XLCYLBASE,
     &	XLCYLBRAS,XDECBRAS,XLCYLAVBRAS,XDECAVBRAS,
     &  AL1MIN,AL2MIN,AL3MIN,AL4MIN,AL5MIN,AL6MIN,
     &  AL1MAX,AL2MAX,AL3MAX,AL4MAX,AL5MAX,AL6MAX,     
     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD, 
     &  IFIND,AL1F,AL2F,AL3F,AL4F,AL5F,AL6F)
	   IF(IFIND.EQ.1) THEN
	   ALPHA10=AL1F*180.D0/PI
	   ALPHA20=AL2F*180.D0/PI	
	   ALPHA30=AL3F*180.D0/PI
	   ALPHA40=AL4F*180.D0/PI
	   ALPHA50=AL5F*180.D0/PI
	   ALPHA60=AL6F*180.D0/PI
           AL1OLD=AL1F
           AL2OLD=AL2F
           AL3OLD=AL3F
           AL4OLD=AL4F
           AL5OLD=AL5F
           AL6OLD=AL6F
           K0=K0+1   
           !write(6,*) 'ici',K0
           TABALPHA10(K0)=AL1F*180.D0/PI
           TABALPHA20(K0)=AL2F*180.D0/PI
           TABALPHA30(K0)=AL3F*180.D0/PI
           TABALPHA40(K0)=AL4F*180.D0/PI
           TABALPHA50(K0)=AL5F*180.D0/PI
           TABALPHA60(K0)=AL6F*180.D0/PI        
           TABGAMMA0(K0)=GAMMA0
           TABDELTA0(K0)=DELTA0        
           TABTETAI0(K0)=TETAI0
           TABPHII0(K0)=PHII0        
           TABTETAO0(K0)=TETAO0
           TABPHIO0(K0)=PHIO0        
           ENDIF        
           ENDDO
         ENDDO
         ENDDO
	   NSAMPLE=K0              
          ! write(6,*) 'ici',NSAMPLE 
 
!XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXxxxxxx        
        ELSEIF(imode.eq.9) THEN !!phii plage , tetai plage de 0 à 90, on balaye le hemisphere
         IDEMI=1
         PHIIDEB0=MAX(PHIIDEB0,PHIIMIN0)
         PHIIFIN0=MIN(PHIIFIN0,PHIIMAX0)
         K0=0
         DO KK=1,NPHII0
         AA = REAL(KK-1,8)/(NPHII0-1)
 	 PHII0=PHIIDEB0+AA*(PHIIFIN0-PHIIDEB0)  
         TETAIDEB0=0.D0
         TETAIFIN0=90.D0
         DO KA=1,NTETAI0!1,NTETAI0
         AA = REAL(KA-1,8)/(NTETAI0-1)
 	 TETAI0=TETAIDEB0+AA*(TETAIFIN0-TETAIDEB0)   
        ! write(6,*) 'a',KA,TETAI0,PHII0
         CALL TETAPHI2ALPHABETA(TETAI0,PHII0,
     &   ALPHA,BETA,XM60A)
         ALPHA0=ALPHA*180.D0/PI
         BETA0=BETA*180.D0/PI
         !write(6,*) 'a2',KA,TETAI0,PHII0,ALPHA0,BETA0         
         DELTADEB0=90.D0  !debut
         DELTAFIN0=180.D0+TETAI0 !fin
         DELTAINC0=180.D0-BETA0 !passage obligé
         !delta moyen
         deltamoyen=(DELTAFIN0-DELTADEB0)/NDELTA0
        ! write(6,*) 'a3',DELTADEB0,DELTAINC0,DELTAFIN0
         !NDELTA=(DELTAFIN0-DELTADEB0)/DDELTA0+1
         IF(ABS(DELTAINC0-DELTADEB0).GT.1.D-12) THEN
         NDELTA=NDELTA0
         NDELTA1=MAX(2,INT((DELTAINC0-DELTADEB0)/deltamoyen))
         IF(ABS(DELTAFIN0-DELTAINC0).GT.1.D-12) THEN
         NDELTA2=MAX(2,NDELTA-NDELTA1)
         NDELTA=NDELTA1+NDELTA2
         ELSE
         NDELTA=NDELTA1
         NDELTA2=0
         ENDIF
         ELSE
         NDELTA1=0
         NDELTA2=NDELTA0
         NDELTA=NDELTA0
         ENDIF
        ! write(6,*) 'a4',NDELTA1,NDELTA2,NDELTA         
        ! IINCRUSTE=0
         DO K=1,NDELTA
          IF(K.LE.NDELTA1) THEN
          AA=REAL(K-1,8)/(NDELTA1-1)
          DELTA0=DELTADEB0+AA*(DELTAINC0-DELTADEB0)
          ELSE
          KB=K-NDELTA1
          AA=REAL(KB,8)/(NDELTA2)
          DELTA0=DELTAINC0+AA*(DELTAFIN0-DELTAINC0)         
          ENDIF
	  CALL PLAGEGAMMA(TETAI0,PHII0,DELTA0,
     &    GAMMADEB,GAMMAFIN)    
          ! write(6,*) 'b',K,DELTA0,GAMMADEB,GAMMAFIN
           !NGAMMA=(GAMMAFIN-GAMMADEB)/DGAMMA0+1   
           NGAMMA=NGAMMA0
           IF(K.EQ.1) THEN
            NGAMMA=1  !dans ce mode je ne duplique pas les points singuliers
            GAMMADEB=-180.D0
            GAMMAFIN=-180.D0
           ENDIF
           IF(K.EQ.NDELTA) THEN
            NGAMMA=1 !dans ce mode je ne duplique pas les poits singuliers
            GAMMADEB=0.D0
            GAMMAFIN=0.D0
           ENDIF           
           IF(IDEMI.EQ.2) THEN
           GAMMAFIN=0.D0
           ENDIF
           DO K2=1,NGAMMA
           IF(MOD(K,2).EQ.0) THEN
            GAMMAINI=GAMMADEB
            GAMMAEND=GAMMAFIN
           ELSE
            GAMMAINI=GAMMAFIN
            GAMMAEND=GAMMADEB          
           ENDIF
           IF(NGAMMA.GT.1) THEN
           AA=REAL(K2-1,8)/(NGAMMA-1)
           ELSE
           AA = 0.D0
           ENDIF
           GAMMA0=GAMMAINI+AA*(GAMMAEND-GAMMAINI)        
          ! write(6,*) 'c',K2,DELTA0,GAMMA0
           CALL ABGDTOTETAPHI(ALPHA0,BETA0,GAMMA0,DELTA0,
     &     TETAI,PHII,TETAO,PHIO) 
           !TETAI0=TETAI*180.D0/PI
           !PHII0=PHII*180.D0/PI
           !write(6,*) 'c2',K,K2,TETAI0,PHII0          
           TETAO0=TETAO*180.D0/PI
           PHIO0=PHIO*180.D0/PI     
           !determination robot 
 !	   XK=XM60A(1,3)
!	   YK=XM60A(2,3)
!	   ZK=XM60A(3,3)
!	   XPP=PX-XK*XLCYLPOIGNEE
!	   YPP=PY-YK*XLCYLPOIGNEE
!	   ZPP=PZ-ZK*XLCYLPOIGNEE-XLCYLBASE	
!	   XM60=XM60A
!	   CALL SOLVEROBOT(XPP,YPP,ZPP,XM60,
!     &	   XLCYLBRAS,XLCYLAVBRAS,
!     &     AL1MIN,AL2MIN,AL3MIN,AL4MIN,AL5MIN,AL6MIN,
!     &     AL1MAX,AL2MAX,AL3MAX,AL4MAX,AL5MAX,AL6MAX,     
!     &     AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD, 
!     &     IFIND,AL1F,AL2F,AL3F,AL4F,AL5F,AL6F)	
	XM60=XM60A
	XK0=XM60(1,3)
	YK0=XM60(2,3)
	ZK0=XM60(3,3)	
	CALL SOLVEROBOT2(XM60,PHII0,
     &  PX,PY,PZ,XK0,YK0,ZK0,K0,
     &  XLCYLPOIGNEE,XDECPOIGNET,XLCYLBASE,
     &	XLCYLBRAS,XDECBRAS,XLCYLAVBRAS,XDECAVBRAS,
     &  AL1MIN,AL2MIN,AL3MIN,AL4MIN,AL5MIN,AL6MIN,
     &  AL1MAX,AL2MAX,AL3MAX,AL4MAX,AL5MAX,AL6MAX,     
     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD, 
     &  IFIND,AL1F,AL2F,AL3F,AL4F,AL5F,AL6F)

	   IF(IFIND.EQ.1) THEN
	   ALPHA10=AL1F*180.D0/PI
	   ALPHA20=AL2F*180.D0/PI	
	   ALPHA30=AL3F*180.D0/PI
	   ALPHA40=AL4F*180.D0/PI
	   ALPHA50=AL5F*180.D0/PI
	   ALPHA60=AL6F*180.D0/PI
           AL1OLD=AL1F
           AL2OLD=AL2F
           AL3OLD=AL3F
           AL4OLD=AL4F
           AL5OLD=AL5F
           AL6OLD=AL6F
           K0=K0+1        
           TABALPHA10(K0)=AL1F*180.D0/PI
           TABALPHA20(K0)=AL2F*180.D0/PI
           TABALPHA30(K0)=AL3F*180.D0/PI
           TABALPHA40(K0)=AL4F*180.D0/PI
           TABALPHA50(K0)=AL5F*180.D0/PI
           TABALPHA60(K0)=AL6F*180.D0/PI        
           TABGAMMA0(K0)=GAMMA0
           TABDELTA0(K0)=DELTA0        
           TABTETAI0(K0)=TETAI0
           TABPHII0(K0)=PHII0        
           TABTETAO0(K0)=TETAO0
           TABPHIO0(K0)=PHIO0        
           ENDIF        
           ENDDO
         ENDDO
         ENDDO
         ENDDO
	 NSAMPLE=K0              	
	
	
	
	
	
	
         ENDIF


         
        
        
        !ecriture des points
        write(6,*) 'ecriture des samples',NSAMPLE
        OPEN(30,file='output/samples')
        write(30,*) 'NOMBRE DE SAMPLES'
        write(30,*) NSAMPLE
        write(30,*) '6 alpha, gamma, delta, tetai, phii, tetao, phio'
        DO K0=1,NSAMPLE
        write(30,'(i10,12f16.6)') K0,TABALPHA10(K0),TABALPHA20(K0),
     &  TABALPHA30(K0),TABALPHA40(K0),TABALPHA50(K0),TABALPHA60(K0),
     &  TABGAMMA0(K0),TABDELTA0(K0),TABTETAI0(K0),TABPHII0(K0),
     &  TABTETAO0(K0),TABPHIO0(K0)
        ENDDO
        CLOSE(30)
        
        

        !TEST
!        CALL TETAPHI2ALPHABETA(TETAI0,PHII0,
!     &  ALPHA,BETA,XM60A)	
!         CALL ABGDTOTETAPHI(ALPHA0,BETA0,GAMMA0,DELTA0,
!     &  TETAI,PHII,TETAO,PHIO)       
!     	write(6,*) 'verification teta phi'
!        write(6,*) 'tetai',TETAI*180.D0/PI
!        write(6,*) 'phii',PHII*180.D0/PI      
!        write(6,*) 'tetao',TETAO*180.D0/PI
!        write(6,*) 'phio',PHIO*180.D0/PI 
!        write(6,*)        
!        write(6,*) ALPHA,BETA
!        write(6,*) 'xm60'
!	write(6,*) XM60A(1,1),XM60A(1,2),XM60A(1,3)
!	write(6,*) XM60A(2,1),XM60A(2,2),XM60A(2,3)
!	write(6,*) XM60A(3,1),XM60A(3,2),XM60A(3,3)
	


        
        IF(IDESSIN.eq.1) THEN
        write(6,*) 'dessin de la scene'
        DO K0=1,NSAMPLE
        
        ALPHA10=TABALPHA10(K0)
        ALPHA20=TABALPHA20(K0)
        ALPHA30=TABALPHA30(K0)
        ALPHA40=TABALPHA40(K0)
        ALPHA50=TABALPHA50(K0)
        ALPHA60=TABALPHA60(K0)        
        GAMMA0=TABGAMMA0(K0)
        DELTA0 =TABDELTA0(K0)      
        TETAI0=TABTETAI0(K0)
        PHII0=TABPHII0(K0) 
        TETAO0=TABTETAO0(K0)
        PHIO0=TABPHIO0(K0)    
        
       
        SUBROUTINE MODE6(TETAI0,PHII0,TETAO0,PHIO0,DELTA0,
     &  NDELTA0,NGAMMA0,IDEMI,PHIIMIN0,PHIIMAX0,
     &  NTETAI0,NPHII0,NTETAO0,PHIIDEB0,PHIIFIN0,
     &  PX,PY,PZ,
     &  XLCYLPOIGNEE,XLCYLBASE,XLCYLBRAS,XLCYLAVBRAS,
     &  XLBRASDETEC,XLBRASLAS,XECHAN,XEPPLATEAU,
     &  XDECBRAS,XDECAVBRAS, XDECPOIGNET,     
     &  AL1MIN,AL1MAX,AL2MIN,AL2MAX,AL3MIN,AL3MAX,
     &  AL4MIN,AL4MAX,AL5MIN,AL5MAX,AL6MIN,AL6MAX,
     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD,     
     &  TABALPHA10,TABALPHA20,TABALPHA30,TABALPHA40,
     &  TABALPHA50,TABALPHA60,TABGAMMA0,TABDELTA0,
     &  TABTETAI0,TABPHII0,TABTETAO0,TABPHIO0,NSAMPLE)     
	IMPLICIT REAL*8 (a-h,o-z)
	REAL*8, PARAMETER :: PI=3.1415926535898D0     
        !sortie
        REAL*8 TABALPHA10(1000000)
        REAL*8 TABALPHA20(1000000)
        REAL*8 TABALPHA30(1000000)
        REAL*8 TABALPHA40(1000000)
        REAL*8 TABALPHA50(1000000)
        REAL*8 TABALPHA60(1000000)
        REAL*8 TABGAMMA0(1000000)
        REAL*8 TABDELTA0(1000000)
        REAL*8 TABTETAI0(1000000)        
        REAL*8 TABPHII0(1000000)          
        REAL*8 TABTETAO0(1000000)  
        REAL*8 TABPHIO0(1000000)
  	!interne
  	REAL*8 XM60(3,3)
	REAL*8 XM60A(3,3),XM60B(3,3)  
        K0=0
	DO K=1,2*NTETAO0-1
	IF(K.LE.NTETAO0) THEN
	 AA = REAL(K-1,8)/(NTETAO0-1)	
         !write(6,*) AA
         TETAODEB=90.D0
         TETAOFIN=0.D0
	 TETAO0=TETAODEB+AA*(TETAOFIN-TETAODEB)
	 PHIO0=PHII0
	ELSE
	 K2=K-NTETAO0
	 AA=REAL(K2,8)/(NTETAO0-1)
         TETAODEB=0.D0
         TETAOFIN=90.D0
	 TETAO0=TETAODEB+AA*(TETAOFIN-TETAODEB)
	 PHIO0=PHII0+180.D0	 
	ENDIF
!	write(6,*) TETAI0,PHII0,TETAO0,PHIO0
	CALL TETAPHI2MAT(TETAI0,PHII0,TETAO0,PHIO0,
     &  ALPHA,BETA,GAMMA,DELTA,XM60A,XM60B)
        ALPHA0=ALPHA*180.D0/PI
        BETA0=BETA*180.D0/PI
        GAMMA0=GAMMA*180.D0/PI
        DELTA0=DELTA*180.D0/PI
        !write(6,*) ALPHA0,BETA0,GAMMA0,DELTA0
!        XK=XM60A(1,3)
!	YK=XM60A(2,3)
!	ZK=XM60A(3,3)
!	XPP=PX-XK*XLCYLPOIGNEE
!	YPP=PY-YK*XLCYLPOIGNEE
!	ZPP=PZ-ZK*XLCYLPOIGNEE-XLCYLBASE	
!	XM60=XM60A
!	CALL SOLVEROBOT(XPP,YPP,ZPP,XM60,
!     &	XLCYLBRAS,XLCYLAVBRAS,
!     &  AL1MIN,AL2MIN,AL3MIN,AL4MIN,AL5MIN,AL6MIN,
!     &  AL1MAX,AL2MAX,AL3MAX,AL4MAX,AL5MAX,AL6MAX,     
!     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD, 
!     &  IFIND,AL1F,AL2F,AL3F,AL4F,AL5F,AL6F)	
	XM60=XM60A
	XK0=XM60(1,3)
	YK0=XM60(2,3)
	ZK0=XM60(3,3)	
	CALL SOLVEROBOT2(XM60,PHII0,
     &  PX,PY,PZ,XK0,YK0,ZK0,K0,
     &  XLCYLPOIGNEE,XDECPOIGNET,XLCYLBASE,
     &	XLCYLBRAS,XDECBRAS,XLCYLAVBRAS,XDECAVBRAS,
     &  AL1MIN,AL2MIN,AL3MIN,AL4MIN,AL5MIN,AL6MIN,
     &  AL1MAX,AL2MAX,AL3MAX,AL4MAX,AL5MAX,AL6MAX,     
     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD, 
     &  IFIND,AL1F,AL2F,AL3F,AL4F,AL5F,AL6F)

	IF(IFIND.EQ.1) THEN
	ALPHA10=AL1F*180.D0/PI
	ALPHA20=AL2F*180.D0/PI	
	ALPHA30=AL3F*180.D0/PI
	ALPHA40=AL4F*180.D0/PI
	ALPHA50=AL5F*180.D0/PI
	ALPHA60=AL6F*180.D0/PI
        AL1OLD=AL1F
        AL2OLD=AL2F
        AL3OLD=AL3F
        AL4OLD=AL4F
        AL5OLD=AL5F
        AL6OLD=AL6F
        K0=K0+1        
        TABALPHA10(K0)=AL1F*180.D0/PI
        TABALPHA20(K0)=AL2F*180.D0/PI
        TABALPHA30(K0)=AL3F*180.D0/PI
        TABALPHA40(K0)=AL4F*180.D0/PI
        TABALPHA50(K0)=AL5F*180.D0/PI
        TABALPHA60(K0)=AL6F*180.D0/PI        
        TABGAMMA0(K0)=GAMMA0
        TABDELTA0(K0)=DELTA0        
        TABTETAI0(K0)=TETAI0
        TABPHII0(K0)=PHII0        
        TABTETAO0(K0)=TETAO0
        TABPHIO0(K0)=PHIO0        
        ENDIF        
        ENDDO
	NSAMPLE=K0   		
	END SUBROUTINE
	
	
        SUBROUTINE MODE5(TETAI0,PHII0,TETAO0,PHIO0,DELTA0,
     &  NDELTA0,NGAMMA0,IDEMI,PHIIMIN0,PHIIMAX0,
     &  NTETAI0,NPHII0,NTETAO0,PHIIDEB0,PHIIFIN0,
     &  PX,PY,PZ,
     &  XLCYLPOIGNEE,XLCYLBASE,XLCYLBRAS,XLCYLAVBRAS,
     &  XLBRASDETEC,XLBRASLAS,XECHAN,XEPPLATEAU,
     &  XDECBRAS,XDECAVBRAS, XDECPOIGNET,     
     &  AL1MIN,AL1MAX,AL2MIN,AL2MAX,AL3MIN,AL3MAX,
     &  AL4MIN,AL4MAX,AL5MIN,AL5MAX,AL6MIN,AL6MAX,
     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD,     
     &  TABALPHA10,TABALPHA20,TABALPHA30,TABALPHA40,
     &  TABALPHA50,TABALPHA60,TABGAMMA0,TABDELTA0,
     &  TABTETAI0,TABPHII0,TABTETAO0,TABPHIO0,NSAMPLE)
	IMPLICIT REAL*8 (a-h,o-z)
	REAL*8, PARAMETER :: PI=3.1415926535898D0     
        !sortie
        REAL*8 TABALPHA10(1000000)
        REAL*8 TABALPHA20(1000000)
        REAL*8 TABALPHA30(1000000)
        REAL*8 TABALPHA40(1000000)
        REAL*8 TABALPHA50(1000000)
        REAL*8 TABALPHA60(1000000)
        REAL*8 TABGAMMA0(1000000)
        REAL*8 TABDELTA0(1000000)
        REAL*8 TABTETAI0(1000000)        
        REAL*8 TABPHII0(1000000)          
        REAL*8 TABTETAO0(1000000)  
        REAL*8 TABPHIO0(1000000)
  	!interne
  	REAL*8 XM60(3,3)
	REAL*8 XM60A(3,3),XM60B(3,3) 
        PHIIDEB0=MAX(PHIIDEB0,PHIIMIN0)
        PHIIFIN0=MIN(PHIIFIN0,PHIIMAX0)
        !write(6,*) PHIIDEB0,PHIIFIN0,NPHII0
        K0=0
        DO K=1,NPHII0
        AA = REAL(K-1,8)/(NPHII0-1)
 	PHII0=PHIIDEB0+AA*(PHIIFIN0-PHIIDEB0)        
	CALL TETAPHI2MAT(TETAI0,PHII0,TETAO0,PHIO0,
     &  ALPHA,BETA,GAMMA,DELTA,XM60A,XM60B)
        ALPHA0=ALPHA*180.D0/PI
        BETA0=BETA*180.D0/PI
        GAMMA0=GAMMA*180.D0/PI
        DELTA0=DELTA*180.D0/PI
        !write(6,*) ALPHA0,BETA0,GAMMA0,DELTA0
!        XK=XM60A(1,3)
!	YK=XM60A(2,3)
!	ZK=XM60A(3,3)
!	XPP=PX-XK*XLCYLPOIGNEE
!	YPP=PY-YK*XLCYLPOIGNEE
!	ZPP=PZ-ZK*XLCYLPOIGNEE-XLCYLBASE	
!	XM60=XM60A
!	CALL SOLVEROBOT(XPP,YPP,ZPP,XM60,
!     &	XLCYLBRAS,XLCYLAVBRAS,
!     &  AL1MIN,AL2MIN,AL3MIN,AL4MIN,AL5MIN,AL6MIN,
!     &  AL1MAX,AL2MAX,AL3MAX,AL4MAX,AL5MAX,AL6MAX,     
!     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD, 
!     &  IFIND,AL1F,AL2F,AL3F,AL4F,AL5F,AL6F)	
	XM60=XM60A
	XK0=XM60(1,3)
	YK0=XM60(2,3)
	ZK0=XM60(3,3)	
	CALL SOLVEROBOT2(XM60,PHII0,
     &  PX,PY,PZ,XK0,YK0,ZK0,K0,
     &  XLCYLPOIGNEE,XDECPOIGNET,XLCYLBASE,
     &	XLCYLBRAS,XDECBRAS,XLCYLAVBRAS,XDECAVBRAS,
     &  AL1MIN,AL2MIN,AL3MIN,AL4MIN,AL5MIN,AL6MIN,
     &  AL1MAX,AL2MAX,AL3MAX,AL4MAX,AL5MAX,AL6MAX,     
     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD, 
     &  IFIND,AL1F,AL2F,AL3F,AL4F,AL5F,AL6F)

	IF(IFIND.EQ.1) THEN
	ALPHA10=AL1F*180.D0/PI
	ALPHA20=AL2F*180.D0/PI	
	ALPHA30=AL3F*180.D0/PI
	ALPHA40=AL4F*180.D0/PI
	ALPHA50=AL5F*180.D0/PI
	ALPHA60=AL6F*180.D0/PI
        AL1OLD=AL1F
        AL2OLD=AL2F
        AL3OLD=AL3F
        AL4OLD=AL4F
        AL5OLD=AL5F
        AL6OLD=AL6F
        K0=K0+1        
        TABALPHA10(K0)=AL1F*180.D0/PI
        TABALPHA20(K0)=AL2F*180.D0/PI
        TABALPHA30(K0)=AL3F*180.D0/PI
        TABALPHA40(K0)=AL4F*180.D0/PI
        TABALPHA50(K0)=AL5F*180.D0/PI
        TABALPHA60(K0)=AL6F*180.D0/PI        
        TABGAMMA0(K0)=GAMMA0
        TABDELTA0(K0)=DELTA0        
        TABTETAI0(K0)=TETAI0
        TABPHII0(K0)=PHII0        
        TABTETAO0(K0)=TETAO0
        TABPHIO0(K0)=PHIO0        
        ENDIF        
        ENDDO
	NSAMPLE=K0         
        END SUBROUTINE	
	
	SUBROUTINE MODE4(TETAI0,PHII0,TETAO0,PHIO0,DELTA0,
     &  NDELTA0,NGAMMA0,IDEMI,PHIIMIN0,PHIIMAX0,
     &  NTETAI0,NPHII0,NTETAO0,PHIIDEB0,PHIIFIN0,
     &  PX,PY,PZ,
     &  XLCYLPOIGNEE,XLCYLBASE,XLCYLBRAS,XLCYLAVBRAS,
     &  XLBRASDETEC,XLBRASLAS,XECHAN,XEPPLATEAU,
     &  XDECBRAS,XDECAVBRAS, XDECPOIGNET,     
     &  AL1MIN,AL1MAX,AL2MIN,AL2MAX,AL3MIN,AL3MAX,
     &  AL4MIN,AL4MAX,AL5MIN,AL5MAX,AL6MIN,AL6MAX,
     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD,     
     &  TABALPHA10,TABALPHA20,TABALPHA30,TABALPHA40,
     &  TABALPHA50,TABALPHA60,TABGAMMA0,TABDELTA0,
     &  TABTETAI0,TABPHII0,TABTETAO0,TABPHIO0,NSAMPLE)
	IMPLICIT REAL*8 (a-h,o-z)
	REAL*8, PARAMETER :: PI=3.1415926535898D0     
        !sortie
        REAL*8 TABALPHA10(1000000)
        REAL*8 TABALPHA20(1000000)
        REAL*8 TABALPHA30(1000000)
        REAL*8 TABALPHA40(1000000)
        REAL*8 TABALPHA50(1000000)
        REAL*8 TABALPHA60(1000000)
        REAL*8 TABGAMMA0(1000000)
        REAL*8 TABDELTA0(1000000)
        REAL*8 TABTETAI0(1000000)        
        REAL*8 TABPHII0(1000000)          
        REAL*8 TABTETAO0(1000000)  
        REAL*8 TABPHIO0(1000000)
  	!interne
  	REAL*8 XM60(3,3)
	REAL*8 XM60A(3,3),XM60B(3,3)  
        TETAIDEB0=0.D0
        TETAIFIN0=90.D0
        K0=0
        DO K=1,NTETAI0
        AA = REAL(K-1,8)/(NTETAI0-1)
 	TETAI0=TETAIDEB0+AA*(TETAIFIN0-TETAIDEB0)        
	CALL TETAPHI2MAT(TETAI0,PHII0,TETAO0,PHIO0,
     &  ALPHA,BETA,GAMMA,DELTA,XM60A,XM60B)
        ALPHA0=ALPHA*180.D0/PI
        BETA0=BETA*180.D0/PI
        GAMMA0=GAMMA*180.D0/PI
        DELTA0=DELTA*180.D0/PI
        !write(6,*) ALPHA0,BETA0,GAMMA0,DELTA0
!        XK=XM60A(1,3)
!	YK=XM60A(2,3)
!	ZK=XM60A(3,3)
!	XPP=PX-XK*XLCYLPOIGNEE
!	YPP=PY-YK*XLCYLPOIGNEE
!	ZPP=PZ-ZK*XLCYLPOIGNEE-XLCYLBASE	
!	XM60=XM60A
!	CALL SOLVEROBOT(XPP,YPP,ZPP,XM60,
!     &	XLCYLBRAS,XLCYLAVBRAS,
!     &  AL1MIN,AL2MIN,AL3MIN,AL4MIN,AL5MIN,AL6MIN,
!     &  AL1MAX,AL2MAX,AL3MAX,AL4MAX,AL5MAX,AL6MAX,     
!     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD, 
!     &  IFIND,AL1F,AL2F,AL3F,AL4F,AL5F,AL6F)	
	XM60=XM60A
	XK0=XM60(1,3)
	YK0=XM60(2,3)
	ZK0=XM60(3,3)	
	CALL SOLVEROBOT2(XM60,PHII0,
     &  PX,PY,PZ,XK0,YK0,ZK0,K0,
     &  XLCYLPOIGNEE,XDECPOIGNET,XLCYLBASE,
     &	XLCYLBRAS,XDECBRAS,XLCYLAVBRAS,XDECAVBRAS,
     &  AL1MIN,AL2MIN,AL3MIN,AL4MIN,AL5MIN,AL6MIN,
     &  AL1MAX,AL2MAX,AL3MAX,AL4MAX,AL5MAX,AL6MAX,     
     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD, 
     &  IFIND,AL1F,AL2F,AL3F,AL4F,AL5F,AL6F)

	IF(IFIND.EQ.1) THEN
	ALPHA10=AL1F*180.D0/PI
	ALPHA20=AL2F*180.D0/PI	
	ALPHA30=AL3F*180.D0/PI
	ALPHA40=AL4F*180.D0/PI
	ALPHA50=AL5F*180.D0/PI
	ALPHA60=AL6F*180.D0/PI
        AL1OLD=AL1F
        AL2OLD=AL2F
        AL3OLD=AL3F
        AL4OLD=AL4F
        AL5OLD=AL5F
        AL6OLD=AL6F
        K0=K0+1        
        TABALPHA10(K0)=AL1F*180.D0/PI
        TABALPHA20(K0)=AL2F*180.D0/PI
        TABALPHA30(K0)=AL3F*180.D0/PI
        TABALPHA40(K0)=AL4F*180.D0/PI
        TABALPHA50(K0)=AL5F*180.D0/PI
        TABALPHA60(K0)=AL6F*180.D0/PI        
        TABGAMMA0(K0)=GAMMA0
        TABDELTA0(K0)=DELTA0        
        TABTETAI0(K0)=TETAI0
        TABPHII0(K0)=PHII0        
        TABTETAO0(K0)=TETAO0
        TABPHIO0(K0)=PHIO0        
        ENDIF        
        ENDDO
	NSAMPLE=K0           
        END SUBROUTINE	
	
	
	SUBROUTINE MODE3(TETAI0,PHII0,TETAO0,PHIO0,DELTA0,
     &  NDELTA0,NGAMMA0,IDEMI,PHIIMIN0,PHIIMAX0,
     &  NTETAI0,NPHII0,NTETAO0,PHIIDEB0,PHIIFIN0,
     &  PX,PY,PZ,
     &  XLCYLPOIGNEE,XLCYLBASE,XLCYLBRAS,XLCYLAVBRAS,
     &  XLBRASDETEC,XLBRASLAS,XECHAN,XEPPLATEAU,
     &  XDECBRAS,XDECAVBRAS, XDECPOIGNET,     
     &  AL1MIN,AL1MAX,AL2MIN,AL2MAX,AL3MIN,AL3MAX,
     &  AL4MIN,AL4MAX,AL5MIN,AL5MAX,AL6MIN,AL6MAX,
     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD,     
     &  TABALPHA10,TABALPHA20,TABALPHA30,TABALPHA40,
     &  TABALPHA50,TABALPHA60,TABGAMMA0,TABDELTA0,
     &  TABTETAI0,TABPHII0,TABTETAO0,TABPHIO0,NSAMPLE)
	IMPLICIT REAL*8 (a-h,o-z)
	REAL*8, PARAMETER :: PI=3.1415926535898D0     
        !sortie
        REAL*8 TABALPHA10(1000000)
        REAL*8 TABALPHA20(1000000)
        REAL*8 TABALPHA30(1000000)
        REAL*8 TABALPHA40(1000000)
        REAL*8 TABALPHA50(1000000)
        REAL*8 TABALPHA60(1000000)
        REAL*8 TABGAMMA0(1000000)
        REAL*8 TABDELTA0(1000000)
        REAL*8 TABTETAI0(1000000)        
        REAL*8 TABPHII0(1000000)          
        REAL*8 TABTETAO0(1000000)  
        REAL*8 TABPHIO0(1000000)
  	!interne
  	REAL*8 XM60(3,3)
	REAL*8 XM60A(3,3),XM60B(3,3)  
         CALL TETAPHI2ALPHABETA(TETAI0,PHII0,
     &   ALPHA,BETA,XM60A)
         ALPHA0=ALPHA*180.D0/PI
         BETA0=BETA*180.D0/PI
         DELTADEB0=90.D0  !debut
         DELTAFIN0=180.D0+TETAI0 !fin
         DELTAINC0=180.D0-BETA0 !passage obligé
         !delta moyen
         deltamoyen=(DELTAFIN0-DELTADEB0)/NDELTA0
   !      write(6,*) DELTADEB0,DELTAINC0,DELTAFIN0
         !NDELTA=(DELTAFIN0-DELTADEB0)/DDELTA0+1
         IF(ABS(DELTAINC0-DELTADEB0).GT.1.D-12) THEN
         NDELTA=NDELTA0
         NDELTA1=MAX(2,INT((DELTAINC0-DELTADEB0)/deltamoyen))
         IF(ABS(DELTAFIN0-DELTAINC0).GT.1.D-12) THEN
         NDELTA2=MAX(2,NDELTA-NDELTA1)
         NDELTA=NDELTA1+NDELTA2
         ELSE
         NDELTA=NDELTA1
         NDELTA2=0
         ENDIF
         ELSE
         NDELTA1=0
         NDELTA2=NDELTA0
         NDELTA=NDELTA0
         ENDIF         
         K0=0
         DO K=1,NDELTA
          IF(K.LE.NDELTA1) THEN
          AA=REAL(K-1,8)/(NDELTA1-1)
          DELTA0=DELTADEB0+AA*(DELTAINC0-DELTADEB0)
          ELSE
          KB=K-NDELTA1
          AA=REAL(KB,8)/(NDELTA2)
          DELTA0=DELTAINC0+AA*(DELTAFIN0-DELTAINC0)         
          ENDIF
	  CALL PLAGEGAMMA(TETAI0,PHII0,DELTA0,
     &    GAMMADEB,GAMMAFIN)    
           NGAMMA=NGAMMA0
           IF(K.EQ.1) THEN
           ! NGAMMA=1  !je duplique les points singuliers parce que je fais un maillage derriere
            GAMMADEB=-180.D0
            GAMMAFIN=-180.D0
           ENDIF
           IF(K.EQ.NDELTA) THEN
           ! NGAMMA=1  !je duplique les points singuliers parce que je fais un maillage derriere
            GAMMADEB=0.D0
            GAMMAFIN=0.D0
           ENDIF           
           IF(IDEMI.EQ.2) THEN
           GAMMAFIN=0.D0
           ENDIF
           DO K2=1,NGAMMA
           IF(MOD(K,2).EQ.0) THEN
            GAMMAINI=GAMMADEB
            GAMMAEND=GAMMAFIN
           ELSE
            GAMMAINI=GAMMAFIN
            GAMMAEND=GAMMADEB          
           ENDIF
           IF(NGAMMA.GT.1) THEN
           AA=REAL(K2-1,8)/(NGAMMA-1)
           ELSE
           AA = 0.D0
           ENDIF
           GAMMA0=GAMMAINI+AA*(GAMMAEND-GAMMAINI)        
           CALL ABGDTOTETAPHI(ALPHA0,BETA0,GAMMA0,DELTA0,
     &     TETAI,PHII,TETAO,PHIO) 
           TETAI0=TETAI*180.D0/PI
           PHII0=PHII*180.D0/PI
           TETAO0=TETAO*180.D0/PI
           PHIO0=PHIO*180.D0/PI     
           !determination robot 
! 	   XK=XM60A(1,3)
!	   YK=XM60A(2,3)
!	   ZK=XM60A(3,3)
!	   XPP=PX-XK*XLCYLPOIGNEE
!	   YPP=PY-YK*XLCYLPOIGNEE
!	   ZPP=PZ-ZK*XLCYLPOIGNEE-XLCYLBASE	
!	   XM60=XM60A
!	   CALL SOLVEROBOT(XPP,YPP,ZPP,XM60,
!     &	   XLCYLBRAS,XLCYLAVBRAS,
!     &     AL1MIN,AL2MIN,AL3MIN,AL4MIN,AL5MIN,AL6MIN,
!     &     AL1MAX,AL2MAX,AL3MAX,AL4MAX,AL5MAX,AL6MAX,     
!     &     AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD, 
!     &     IFIND,AL1F,AL2F,AL3F,AL4F,AL5F,AL6F)	

	XM60=XM60A
	XK0=XM60(1,3)
	YK0=XM60(2,3)
	ZK0=XM60(3,3)	
	CALL SOLVEROBOT2(XM60,PHII0,
     &  PX,PY,PZ,XK0,YK0,ZK0,K0,
     &  XLCYLPOIGNEE,XDECPOIGNET,XLCYLBASE,
     &	XLCYLBRAS,XDECBRAS,XLCYLAVBRAS,XDECAVBRAS,
     &  AL1MIN,AL2MIN,AL3MIN,AL4MIN,AL5MIN,AL6MIN,
     &  AL1MAX,AL2MAX,AL3MAX,AL4MAX,AL5MAX,AL6MAX,     
     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD, 
     &  IFIND,AL1F,AL2F,AL3F,AL4F,AL5F,AL6F)

	   IF(IFIND.EQ.1) THEN
	   ALPHA10=AL1F*180.D0/PI
	   ALPHA20=AL2F*180.D0/PI	
	   ALPHA30=AL3F*180.D0/PI
	   ALPHA40=AL4F*180.D0/PI
	   ALPHA50=AL5F*180.D0/PI
	   ALPHA60=AL6F*180.D0/PI
           AL1OLD=AL1F
           AL2OLD=AL2F
           AL3OLD=AL3F
           AL4OLD=AL4F
           AL5OLD=AL5F
           AL6OLD=AL6F
           K0=K0+1        
           TABALPHA10(K0)=AL1F*180.D0/PI
           TABALPHA20(K0)=AL2F*180.D0/PI
           TABALPHA30(K0)=AL3F*180.D0/PI
           TABALPHA40(K0)=AL4F*180.D0/PI
           TABALPHA50(K0)=AL5F*180.D0/PI
           TABALPHA60(K0)=AL6F*180.D0/PI        
           TABGAMMA0(K0)=GAMMA0
           TABDELTA0(K0)=DELTA0        
           TABTETAI0(K0)=TETAI0
           TABPHII0(K0)=PHII0        
           TABTETAO0(K0)=TETAO0
           TABPHIO0(K0)=PHIO0        
           ENDIF        
           ENDDO
          ENDDO
	   NSAMPLE=K0 	
	END SUBROUTINE
	
	SUBROUTINE MODE2(TETAI0,PHII0,TETAO0,PHIO0,DELTA0,
     &  NDELTA0,NGAMMA0,IDEMI,PHIIMIN0,PHIIMAX0,
     &  NTETAI0,NPHII0,NTETAO0,PHIIDEB0,PHIIFIN0,
     &  PX,PY,PZ,
     &  XLCYLPOIGNEE,XLCYLBASE,XLCYLBRAS,XLCYLAVBRAS,
     &  XLBRASDETEC,XLBRASLAS,XECHAN,XEPPLATEAU,
     &  XDECBRAS,XDECAVBRAS, XDECPOIGNET,     
     &  AL1MIN,AL1MAX,AL2MIN,AL2MAX,AL3MIN,AL3MAX,
     &  AL4MIN,AL4MAX,AL5MIN,AL5MAX,AL6MIN,AL6MAX,
     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD,     
     &  TABALPHA10,TABALPHA20,TABALPHA30,TABALPHA40,
     &  TABALPHA50,TABALPHA60,TABGAMMA0,TABDELTA0,
     &  TABTETAI0,TABPHII0,TABTETAO0,TABPHIO0,NSAMPLE)
	IMPLICIT REAL*8 (a-h,o-z)
	REAL*8, PARAMETER :: PI=3.1415926535898D0     
        !sortie
        REAL*8 TABALPHA10(1000000)
        REAL*8 TABALPHA20(1000000)
        REAL*8 TABALPHA30(1000000)
        REAL*8 TABALPHA40(1000000)
        REAL*8 TABALPHA50(1000000)
        REAL*8 TABALPHA60(1000000)
        REAL*8 TABGAMMA0(1000000)
        REAL*8 TABDELTA0(1000000)
        REAL*8 TABTETAI0(1000000)        
        REAL*8 TABPHII0(1000000)          
        REAL*8 TABTETAO0(1000000)  
        REAL*8 TABPHIO0(1000000)
  	!interne
  	REAL*8 XM60(3,3)
	REAL*8 XM60A(3,3),XM60B(3,3)   
        CALL TETAPHI2ALPHABETA(TETAI0,PHII0,
     &  ALPHA,BETA,XM60A)
        ALPHA0=ALPHA*180.D0/PI
        BETA0=BETA*180.D0/PI
        CALL PLAGEGAMMA(TETAI0,PHII0,DELTA0,
     &  GAMMADEB,GAMMAFIN)        
        NGAMMA=NGAMMA0
        K0=0       
        DO K=1,NGAMMA
        AA=REAL(K-1,8)/(NGAMMA-1)
        GAMMA0=GAMMADEB+AA*(GAMMAFIN-GAMMADEB)        
        CALL ABGDTOTETAPHI(ALPHA0,BETA0,GAMMA0,DELTA0,
     &  TETAI,PHII,TETAO,PHIO) 
        TETAI0=TETAI*180.D0/PI
        PHII0=PHII*180.D0/PI
        TETAO0=TETAO*180.D0/PI
        PHIO0=PHIO*180.D0/PI     

	!en entree : XM60,PHIO0,
	!PX,PY,PZ,XK0,YK0,ZK0,
	!XLCYLPOIGNEE,XDECPOIGNET,XLCYLBASE
	!XLCYLBRAS,XDECBRAS,XLCYLAVBRAS,XDECAVBRAS,
	!AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD,
	!AL1MAX,AL2MAX,AL3MAX,AL4MAX,AL5MAX,AL6MAX,
	!AL1MIN,AL2MIN,AL3MIN,AL4MIN,AL5MIN,AL6MIN,	
	SUBROUTINE SOLVEROBOT2(XM60,PHII0,
     &  PX,PY,PZ,XK0,YK0,ZK0,K0,
     &  XLCYLPOIGNEE,XDECPOIGNET,XLCYLBASE,
     &	XLCYLBRAS,XDECBRAS,XLCYLAVBRAS,XDECAVBRAS,
     &  AL1MIN,AL2MIN,AL3MIN,AL4MIN,AL5MIN,AL6MIN,
     &  AL1MAX,AL2MAX,AL3MAX,AL4MAX,AL5MAX,AL6MAX,     
     &  AL1OLD,AL2OLD,AL3OLD,AL4OLD,AL5OLD,AL6OLD, 
     &  IFIND,AL1F,AL2F,AL3F,AL4F,AL5F,AL6F)
	IMPLICIT REAL*8 (a-h,o-z)
	REAL*8, PARAMETER :: PI=3.1415926535898D0
        REAL*8 XM1(3,3)
        REAL*8 XM2(3,3),XM3(3,3)
        REAL*8 XMT(3,3),XM(3,3)
	REAL*8 XM03(3,3),XM60(3,3)
	REAL*8 XM63(3,3)
        REAL*8 XJ1(3),XJ2(3)
        !1 j'initialise un alpha6
        KBOUCLE=0
        IF(K0.eq.0) then
	ALPHA60=90.D0-PHII0
	else
	ALPHA60=AL6OLD*180.D0/PI
	ENDIF
!	write(6,*) 'al6ini',ALPHA60
        
 253    ALPHA6=ALPHA60*PI/180.D0
        ALPHA6INIT=ALPHA60*PI/180.D0        
!        write(6,*) 'alpha6 init',ALPHA6INIT*180.D0/PI
        
        !je cherche j5 pour ce alpha6
        XJ1(1)=-SIN(-ALPHA6)
        XJ1(2)=COS(-ALPHA6)
        XJ1(3)=0.D0
   	CALL MATXVEC(XM60,XJ1,XJ2)     
!   	write(6,*) PX,PY,PZ
!   	write(6,*) XK0,YK0,ZK0   	
        !je calcule Pprime pour ce alpha6
	XPP=PX-XK0*XLCYLPOIGNEE-XJ2(1)*XDECPOIGNET
	YPP=PY-YK0*XLCYLPOIGNEE-XJ2(2)*XDECPOIGNET
	ZPP=PZ-ZK0*XLCYLPOIGNEE-XJ2(3)*XDECPOIGNET-XLCYLBASE
!	write(6,*) XPP,YPP,ZPP
	!passage de calcul de alpha1,alpha2 et alpha3
	XL=SQRT(XPP*XPP+YPP*YPP+ZPP*ZPP)
	XD=SQRT(XPP*XPP+YPP*YPP)
	XLA=SQRT(XLCYLBRAS**2+XDECBRAS**2)
	XLB=SQRT(XLCYLAVBRAS**2+XDECAVBRAS**2)
	PSIB=ATAN(XDECAVBRAS/XLCYLAVBRAS)
	PSIA=ATAN(XDECBRAS/XLCYLBRAS)
!	write(6,*) XL,XD
!	write(6,*) XLA,XLB
!	write(6,*) PSIA*180.D0/PI
!	write(6,*) PSIB*180.D0/PI
	
	IERREUR=0
	IFIND123=0
	DTMIN=1.D30
	IFIND=0
	AL1=ATAN2(XPP,-YPP) 
	ALR1=AL1
	IF(AL1.LT.-PI) ALR1=2.D0*PI+AL1
	IF(AL1.GT.PI) ALR1=AL1-2.D0*PI
	IF((ALR1.GT.AL1MAX).OR.(ALR1.LT.AL1MIN)) IERREUR=2
	AL1=ALR1
	PHI=ATAN2(ZPP,XD)
!	write(6,*) PHI
!	ICODE3=1!2!1!,2
	AA = (XL**2-XLA**2-XLB**2)
	BB = (-2.D0*XLA*XLB)
	CC=AA/BB
!	write(6,*)  'xl,xla,xlb'
!	write(6,*) xl,xla,xlb
!	write(6,*) CC
	IF (ABS(CC).LE.1.D0) THEN
	 TETA2=ACOS(CC)
	 AL3=PI-TETA2
	 AL3=AL3+PSIB
!	 IF (ICODE3.eq.2) THEN
!	 TETA2=-ACOS(CC)
!	 AL3=-TETA2-PI
!	 AL3=AL3+PSIB
!	 ENDIF
	ELSE 
	 IERREUR=1
	ENDIF
	!WRITE(6,*) 'al',al3
	AA = (XLB**2-XLA**2-XL**2)
	BB = (-2.D0*XLA*XL)
	CC=AA/BB
	IF (ABS(CC).LE.1.D0) THEN
	 TETAA=ACOS(CC)
	 TETA1=PHI+TETAA
	 AL2=PI/2.D0-TETA1
	 AL2=AL2-psia
!	 IF(ICODE3.eq.2) THEN
!	 TETA1=PHI-TETAA
!	 AL2=PI/2.D0-TETA1	 
!	 AL2=AL2-psia
!	 ENDIF
	ELSE 
	 IERREUR=1
	ENDIF	
        AL3=AL3+psia
        
        !on verifie les bornes ed alpha1, alpha2 ou alpha3
	!write(6,*) '123',ICODE1,ICODE3,AL1,AL2,AL3
	IF((AL2.GT.AL2MAX).OR.(AL2.LT.AL2MIN)) IERREUR=2
	IF((AL3.GT.AL3MAX).OR.(AL3.LT.AL3MIN)) IERREUR=2	
!        write(6,*) AL2,AL3,IERREUR
	IF (IERREUR.EQ.0) THEN
	 IFIND123=1
	ENDIF! on continue pascycle
	
	IF(IFIND123.ne.1) then
!	 write(6,*) 'pas de al1,2,3 valide'
!        write(6,*) al1*180.D0/PI
!        write(6,*) al2*180.D0/PI
!        write(6,*) al3*180.D0/PI	 
	ELSE
!        write(6,*) al1*180.D0/PI
!        write(6,*) al2*180.D0/PI
!        write(6,*) al3*180.D0/PI,AL3MIN*180.D0/PI
     	CALL ROTALPHA1Z(AL1,XM1)
	CALL ROTALPHA1X(AL2,XM2)
	CALL ROTALPHA1X(AL3,XM3)	
	CALL MATXMAT1(XM2,XM3,XMT)
	CALL MATXMAT1(XM1,XMT,XM)	
	CALL INVROT(XM,XM03)	
	CALL MATXMAT1(XM03,XM60,XM63)	!je fais M03*M60
	XI=XM63(1,1)
	YI=XM63(2,1)
	ZI=XM63(3,1)
	XJ=XM63(1,2)
	YJ=XM63(2,2)
	ZJ=XM63(3,2)
	XK=XM63(1,3)
	YK=XM63(2,3)
	ZK=XM63(3,3)	
!	write(6,*) 'IJK 63'
!	write(6,*) XI,YI,ZI
!	write(6,*) XJ,YJ,ZJ
!	write(6,*) XK,YK,ZK
	AL5T=ACOS(ZK)
!	write(6,*) 'AL5T',AL5T,SIN(AL5T)
	IF(SIN(AL5T).GT.1.d-7) THEN
	DO ICODE5=1,2	
	DO ICODE4=1,2
	DO ICODE6=1,2			
	AL5=AL5T
	IF(ICODE5.eq.2) AL5=-AL5T
	AA=MIN(MAX(XK/SIN(AL5),-1.D0),1.D0)
	AL4T=ASIN(AA)
	AL4=AL4T
	IF(ICODE4.eq.2) AL4=PI-AL4T	
	AA=MIN(MAX(ZI/SIN(AL5),-1.D0),1.D0)
	AL6T=ASIN(AA)
	AL6=AL6T
	IF(ICODE6.eq.2) AL6=PI-AL6T
	CALL MAT63(AL4,AL5,AL6,XM)
!	write(6,*) '456',ICODE4,ICODE5,ICODE6
!	write(6,*) AL4,AL5,AL6,ZI/SIN(AL5)
!	write(6,*) XM(1,1),XM(1,2),XM(1,3)
!	write(6,*) XM(2,1),XM(2,2),XM(2,3)
!	write(6,*) XM(3,1),XM(3,2),XM(3,3) 
	!compare les signes
	KCOUNT=0
	KCOUNTOK=0
	DO I=1,3
	DO J=1,3
	 IF(ABS(XM63(I,J)).GT.1.D-12) THEN
	 KCOUNTOK=KCOUNTOK+1
	 AA=XM(I,J)*XM63(I,J)
	 IF(AA.GE.0.D0) KCOUNT=KCOUNT+1
!	 write(6,*) I,J,XM63(I,J),XM(I,J)
	 ENDIF
	ENDDO
	ENDDO
! 	write(6,*) KCOUNTOK,KCOUNT
	IF(KCOUNT.eq.KCOUNTOK) THEN
	!on verifie les bornes
	IERREUR=0
	IF((AL5.GT.AL5MAX).OR.(AL5.LT.AL5MIN)) IERREUR=2        
	ALR4=AL4
	IF(AL4.LT.-PI) ALR4=2.D0*PI+AL4
	IF(AL4.GT.PI) ALR4=AL4-2.D0*PI
	IF((ALR4.GT.AL4MAX).OR.(ALR4.LT.AL4MIN)) IERREUR=2   
	AL4=ALR4
	ALR6=AL6
	IF(AL6.LT.-PI) ALR6=2.D0*PI+AL6
	IF(AL6.GT.PI) ALR6=AL6-2.D0*PI
	IF((ALR6.GT.AL6MAX).OR.(ALR6.LT.AL6MIN)) IERREUR=2   	
	AL6=ALR6
!	write(6,*) '456',ICODE4,ICODE5,ICODE6
!	write(6,*) AL4,AL5,AL6,IERREUR
	!	write(6,*) 'jio',AL6,ALR6
	!on a trouve une solution et elle est valide
	!je la grade si le chemin parcouru est le moins long
	!par rapport à la précédente position
	IF(IERREUR.eq.0) THEN
	DAL1=ABS(AL1-AL1OLD)
	DAL2=ABS(AL2-AL2OLD)
	DAL3=ABS(AL3-AL3OLD)
	DAL4=ABS(AL4-AL4OLD)
	DAL5=ABS(AL5-AL5OLD)
	DAL6=ABS(AL6-AL6OLD)
	DT=DAL1+DAL2+DAL3
	DT=DT+DAL4+DAL5+DAL6
!	write(6,*) 'dt,dtmin',dt,dtmin
	IF(DT.Lt.DTMIN) THEN
	 IFIND=1
	 AL1F=AL1
	 AL2F=AL2
	 AL3F=AL3
	 AL4F=AL4
	 AL5F=AL5
	 AL6F=AL6
         DTMIN=DT
!	 AL1OLD=AL1F
!	 AL2OLD=AL2F
!	 AL3OLD=AL3F
!	 AL4OLD=AL4F
!	 AL5OLD=AL5F
!	 AL6OLD=AL6F	 
!        write(6,*) 'u',DT,DTMIN
!	write(6,*) AL1F*180.D0/PI
!	write(6,*) AL2F*180.D0/PI	
!	write(6,*) AL3F*180.D0/PI
!	write(6,*) AL4F*180.D0/PI
!	write(6,*) AL5F*180.D0/PI	
!	write(6,*) AL6F*180.D0/PI
	ENDIF
	ENDIF
	ENDIF
	ENDDO
	ENDDO
	ENDDO
	ELSE !AL5T=0.D0
	 AL46=ACOS(XI)
	 !write(6,*) 'al46',al46
	 IF(AL46.LT.(2.D0*PI/3.D0)) THEN
	  AL4=0.D0
	  AL6=AL46
	  AL5=AL5T
	 ELSE
	  AL4=0.5*AL46
	  AL6=0.5*AL46
	  AL5=AL5T	  
	 ENDIF
	 IERREUR=0
	DAL1=ABS(AL1-AL1OLD)
	DAL2=ABS(AL2-AL2OLD)
	DAL3=ABS(AL3-AL3OLD)
	DAL4=ABS(AL4-AL4OLD)
	DAL5=ABS(AL5-AL5OLD)
	DAL6=ABS(AL6-AL6OLD)
	DT=DAL1+DAL2+DAL3
	DT=DT+DAL4+DAL5+DAL6
	IF(DT.Lt.DTMIN) THEN
	 IFIND=1
	 AL1F=AL1
	 AL2F=AL2
	 AL3F=AL3
	 AL4F=AL4
	 AL5F=AL5
	 AL6F=AL6
	 DTMIN=DT
!	 AL1OLD=AL1F
!	 AL2OLD=AL2F
!	 AL3OLD=AL3F
!	 AL4OLD=AL4F
!	 AL5OLD=AL5F
!	 AL6OLD=AL6F	  
	 
	ENDIF
	ENDIF	
	IF(IFIND.EQ.1) THEN
	DALFA6=abs(al6f-ALPHA6INIT)
	IF((DALFA6.GT.1.D-10).AND.(KBOUCLE.LT.300)) THEN!100
	 KBOUCLE=KBOUCLE+1
	 ALPHA60=0.5D0*(al6f+ALPHA6INIT)*180.D0/PI
	 ALPHA60=(ALPHA6INIT+0.2D0*(al6f-ALPHA6INIT))*180.D0/PI	 
	 
	 AL1OLD=AL1F
	 AL2OLD=AL2F
	 AL3OLD=AL3F
	 AL4OLD=AL4F
	 AL5OLD=AL5F
	 AL6OLD=AL6F
	 
!        write(6,*) al1f*180.D0/PI
!        write(6,*) al2f*180.D0/PI
!        write(6,*) al3f*180.D0/PI	
!        write(6,*) al4f*180.D0/PI
!        write(6,*) al5f*180.D0/PI
!        write(6,*) al6f*180.D0/PI 
!	 write(6,*)
!	 write(6,*) 'nouvelle boucle',AL6F*180.D0/PI
	 GOTO 253
	ENDIF
	ENDIF
!        write(6,*) al1f*180.D0/PI
!        write(6,*) al2f*180.D0/PI
!        write(6,*) al3f*180.D0/PI	
!        write(6,*) al4f*180.D0/PI
!        write(6,*) al5f*180.D0/PI
!        write(6,*) al6f*180.D0/PI 
	 ENDIF
        
        END SUBROUTINE
